name: Release Build

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version tag (e.g., v0.2.0)"
                required: false

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        name: Build ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Linux x86_64
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      artifact: hcp-cli

                    # Linux x86_64 static (musl)
                    - target: x86_64-unknown-linux-musl
                      os: ubuntu-latest
                      artifact: hcp-cli

                    # Linux ARM64
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-latest
                      artifact: hcp-cli
                      use-cross: true

                    # macOS Intel
                    - target: x86_64-apple-darwin
                      os: macos-latest
                      artifact: hcp-cli

                    # macOS Apple Silicon
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      artifact: hcp-cli

                    # Windows
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      artifact: hcp-cli.exe

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                targets: ${{ matrix.target }}

            - name: Install musl tools (Linux musl)
              if: matrix.target == 'x86_64-unknown-linux-musl'
              run: sudo apt-get update && sudo apt-get install -y musl-tools

            - name: Install cross (ARM64)
              if: matrix.use-cross
              run: cargo install cross

            - name: Build (cross)
              if: matrix.use-cross
              run: cross build --release --target ${{ matrix.target }}

            - name: Build (cargo)
              if: ${{ !matrix.use-cross }}
              run: cargo build --release --target ${{ matrix.target }}

            - name: Prepare artifact
              shell: bash
              run: |
                  VERSION=${GITHUB_REF_NAME:-${{ github.event.inputs.version || 'dev' }}}
                  ARTIFACT_NAME="hcp-cli-${VERSION}-${{ matrix.target }}"

                  if [[ "${{ matrix.target }}" == *"windows"* ]]; then
                    ARTIFACT_NAME="${ARTIFACT_NAME}.exe"
                  fi

                  mkdir -p dist
                  cp "target/${{ matrix.target }}/release/${{ matrix.artifact }}" "dist/${ARTIFACT_NAME}"

                  echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.ARTIFACT_NAME }}
                  path: dist/${{ env.ARTIFACT_NAME }}

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: dist/*
                  generate_release_notes: true
